<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GreenLinks</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: #e6ffe6;
            font-family: 'Roboto', sans-serif;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: auto;
        }

        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            background: #fff;
        }

        .card-header {
            background: linear-gradient(to right, #28a745, #218838);
            color: white;
            border-radius: 10px 10px 0 0;
            padding: 15px;
            font-size: 1.25rem;
        }

        .card-body {
            padding: 20px;
        }

        .btn-custom {
            background-color: #28a745;
            color: white;
            border-radius: 20px;
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            transition: background-color 0.3s ease;
        }

            .btn-custom:hover {
                background-color: #218838;
            }

        .player-chain-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 20px 0;
        }

        .player-chain {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            margin-bottom: 30px;
        }

            .player-chain span {
                display: block;
                font-size: 24px;
                background: #e9ecef;
                padding: 10px 20px;
                border-radius: 5px;
            }

        .arrow {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #28a745;
            color: white;
            font-size: 24px;
            margin: 10px 0;
        }

            .arrow.invalid-link {
                background-color: #dc3545;
            }

        .text-danger, .text-success {
            margin-top: 20px;
        }

        .invalid-link-message {
            color: #dc3545;
            font-size: 16px;
            margin-top: 10px;
        }

        .form-control.valid {
            border: 2px solid #28a745;
        }

        .form-control.invalid {
            border: 2px solid #dc3545;
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
        }

        .form-group {
            flex: 1;
            margin-right: 10px;
        }

        .autocomplete-suggestions {
            border: 1px solid #ccc;
            background: #fff;
            overflow: auto;
            position: absolute;
            z-index: 9999;
            max-height: 150px;
        }

        .autocomplete-suggestion {
            padding: 8px;
            cursor: pointer;
        }

            .autocomplete-suggestion:hover {
                background: #ddd;
            }

        .dark-mode {
            background-color: #121212;
            color: #e0e0e0;
        }

            .dark-mode .btn-custom {
                background-color: #444;
                color: #e0e0e0;
            }

                .dark-mode .btn-custom:hover {
                    background-color: #666;
                }

            .dark-mode .card {
                background-color: #1e1e1e;
                color: #e0e0e0;
                border: none;
                border-radius: 10px;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            }

            .dark-mode .card-header {
                background: linear-gradient(to right, #444, #666);
                color: #e0e0e0;
            }

            .dark-mode .table {
                background-color: #1e1e1e;
                color: #e0e0e0;
            }

                .dark-mode .table th,
                .dark-mode .table td {
                    color: #e0e0e0;
                }

            .dark-mode .link {
                color: #76c7c0;
            }

        .loading-spinner {
            display: none;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="card-header">GreenLinks</div>
            <div class="card-body text-center">
                <button id="toggle-dark-mode" class="btn btn-secondary mb-3">Toggle Dark Mode</button>
                <form id="chain-form" method="POST">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="start-player">Start Player:</label>
                        <input type="text" id="start-player" name="start-player" class="form-control" value="{{ start_player }}" readonly>
                    </div>
                    <div id="intermediate-players" class="form-row"></div>
                    <div class="form-group">
                        <label for="end-player">End Player:</label>
                        <input type="text" id="end-player" name="end-player" class="form-control" value="{{ end_player }}" readonly>
                    </div>
                    <div class="form-group">
                        <button type="button" id="add-player" class="btn btn-secondary mb-3">Add Intermediate Player</button>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-custom">Submit Chain</button>
                        <div class="loading-spinner" id="loading-spinner">
                            <div class="spinner-border text-primary" role="status">
                                <span class="sr-only">Searching...</span>
                            </div>
                        </div>
                    </div>
                </form>
                <div id="result" class="player-chain-container"></div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('chain-form');
            const intermediatePlayersContainer = document.getElementById('intermediate-players');
            const resultContainer = document.getElementById('result');
            const loadingSpinner = document.getElementById('loading-spinner');
            const addPlayerButton = document.getElementById('add-player');
            let playerCount = 0;

            if (addPlayerButton) {
                addPlayerButton.addEventListener('click', function () {
                    playerCount++;
                    const div = document.createElement('div');
                    div.classList.add('form-group');
                    div.setAttribute('id', `player-group-${playerCount}`);
                    div.innerHTML = `
                                <input type="text" id="intermediate-player-${playerCount}" name="intermediate-player-${playerCount}" class="form-control intermediate-player">
                                <div id="intermediate-player-suggestions-${playerCount}" class="autocomplete-suggestions"></div>
                            `;
                    intermediatePlayersContainer.appendChild(div);
                    setupAutocomplete(`intermediate-player-${playerCount}`, `intermediate-player-suggestions-${playerCount}`);
                });
            }

            if (form) {
                form.addEventListener('submit', async function (event) {
                    event.preventDefault();
                    loadingSpinner.style.display = 'inline-block';
                    const startPlayer = document.getElementById('start-player').value;
                    const endPlayer = document.getElementById('end-player').value;
                    const intermediatePlayers = [];
                    for (let i = 1; i <= playerCount; i++) {
                        const playerInput = document.getElementById(`intermediate-player-${i}`);
                        if (playerInput) {
                            const player = playerInput.value;
                            if (player) {
                                intermediatePlayers.push(player);
                            }
                        }
                    }

                    try {
                        const response = await fetch('/game/validate_chain/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                            },
                            body: JSON.stringify({
                                start_player: startPlayer,
                                end_player: endPlayer,
                                intermediate_players: intermediatePlayers
                            })
                        });

                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }

                        const data = await response.json();
                        loadingSpinner.style.display = 'none';

                        // Reset all input colors
                        document.querySelectorAll('.form-control').forEach(input => {
                            input.classList.remove('valid', 'invalid');
                        });

                        const chainElements = [startPlayer, ...intermediatePlayers, endPlayer];

                        // Validate links and update colors
                        if (Array.isArray(data.invalid_links)) {
                            data.invalid_links.forEach(link => {
                                const fromPlayer = link.from.toLowerCase();
                                const toPlayer = link.to.toLowerCase();

                                // Update input colors
                                chainElements.forEach((player, index) => {
                                    if (index < chainElements.length - 1) {
                                        const currentPlayer = chainElements[index].toLowerCase();
                                        const nextPlayer = chainElements[index + 1].toLowerCase();
                                        if ((currentPlayer === fromPlayer && nextPlayer === toPlayer) ||
                                            (currentPlayer === toPlayer && nextPlayer === fromPlayer)) {
                                            const input = document.getElementById(`intermediate-player-${index + 1}`);
                                            if (input) {
                                                input.classList.add('invalid');
                                            }
                                        }
                                    }
                                });
                            });
                        }

                        // Update valid inputs
                        chainElements.forEach((player, index) => {
                            if (index > 0 && index < chainElements.length - 1) {
                                const currentPlayer = chainElements[index].toLowerCase();
                                const prevPlayer = chainElements[index - 1].toLowerCase();
                                const nextPlayer = chainElements[index + 1].toLowerCase();
                                const isValidLink = Array.isArray(data.invalid_links) && data.invalid_links.every(link => {
                                    return !(link.from.toLowerCase() === prevPlayer && link.to.toLowerCase() === currentPlayer) &&
                                        !(link.from.toLowerCase() === currentPlayer && link.to.toLowerCase() === nextPlayer);
                                });
                                if (isValidLink) {
                                    const input = document.getElementById(`intermediate-player-${index}`);
                                    if (input) {
                                        input.classList.add('valid');
                                    }
                                }
                            }
                        });

                        // Display arrows and player chain with detailed tables
                        resultContainer.innerHTML = '';
                        chainElements.forEach((player, index) => {
                            if (index < chainElements.length - 1) {
                                const nextPlayer = chainElements[index + 1];
                                const arrowClass = Array.isArray(data.invalid_links) && data.invalid_links.some(link => {
                                    return link.from.toLowerCase() === player.toLowerCase() && link.to.toLowerCase() === nextPlayer.toLowerCase();
                                }) ? 'invalid-link' : 'valid-link';

                                resultContainer.innerHTML += `
                                            <div class="player-chain">
                                                <span>${player}</span>
                                                <div class="arrow ${arrowClass}">â†“</div>
                                            </div>
                                        `;
                            }
                        });
                        resultContainer.innerHTML += `<div class="player-chain"><span>${chainElements[chainElements.length - 1]}</span></div>`;

                        // Display detailed results
                        if (Array.isArray(data.links)) {
                            chainElements.forEach((player, index) => {
                                if (index < chainElements.length - 1) {
                                    const link = data.links.find(link => link.from === player && link.to === chainElements[index + 1]);
                                    if (link) {
                                        let detailHTML = `
                                                    <div class="card">
                                                        <div class="card-header">${player}</div>
                                                        <div class="card-body">
                                                            <p>Common Clubs:</p>
                                                            <table class="table table-bordered card-table">
                                                                <thead><tr><th>Season</th><th>Club</th></tr></thead>
                                                                <tbody>`;
                                        link.common_clubs.forEach(club => {
                                            detailHTML += `<tr><td>${club.season}</td><td>${club.team}</td></tr>`;
                                        });
                                        detailHTML += `</tbody></table>`;
                                        if (link.common_intl.length > 0) {
                                            detailHTML += `<p>Common International Teams:</p>
                                                        <table class="table table-bordered card-table">
                                                            <thead><tr><th>Season</th><th>Team</th></tr></thead>
                                                            <tbody>`;
                                            link.common_intl.forEach(team => {
                                                detailHTML += `<tr><td>${team.season}</td><td>${team.team}</td></tr>`;
                                            });
                                            detailHTML += `</tbody></table>`;
                                        }
                                        detailHTML += `</div></div>`;
                                        resultContainer.innerHTML += detailHTML;
                                    }
                                }
                            });
                        }

                        // Display feedback message
                        if (Array.isArray(data.invalid_links) && data.invalid_links.length > 0) {
                            let resultHTML = '<p class="text-danger">Invalid chain! Issues with the following links:</p><ul>';
                            data.invalid_links.forEach(link => {
                                resultHTML += `<li class="invalid-link-message">From <strong>${link.from}</strong> <span class="chain-link">&#x2192;</span> <strong>${link.to}</strong> (${link.reason})</li>`;
                            });
                            resultHTML += '</ul>';
                            resultContainer.innerHTML += resultHTML;
                        } else {
                            resultContainer.innerHTML += '<p class="text-success">Valid chain!</p>';
                        }
                    } catch (error) {
                        loadingSpinner.style.display = 'none';
                        console.error('Error:', error);
                        resultContainer.innerHTML = '<p class="text-danger">An error occurred while validating the chain. Please try again later.</p>';
                    }
                });
            }

            function setupAutocomplete(inputId, suggestionsId) {
                const input = document.getElementById(inputId);
                const suggestionsBox = document.getElementById(suggestionsId);
                const cache = {};

                let timeout = null;

                if (input) {
                    input.addEventListener('input', function () {
                        clearTimeout(timeout);
                        const query = input.value;

                        if (query.length < 2) {
                            if (suggestionsBox) {
                                suggestionsBox.innerHTML = '';
                            }
                            return;
                        }

                        if (cache[query]) {
                            displaySuggestions(cache[query]);
                        } else {
                            timeout = setTimeout(async () => {
                                const response = await fetch(`/game/suggest_player_names?query=${encodeURIComponent(query)}`);
                                const suggestions = await response.json();
                                cache[query] = suggestions;
                                displaySuggestions(suggestions);
                            }, 300); // 300 ms delay to reduce number of requests
                        }
                    });
                }

                function displaySuggestions(suggestions) {
                    if (suggestionsBox) {
                        suggestionsBox.innerHTML = '';
                        suggestions.forEach(suggestion => {
                            const div = document.createElement('div');
                            div.classList.add('autocomplete-suggestion');
                            div.textContent = suggestion;
                            div.addEventListener('click', function () {
                                input.value = suggestion;
                                suggestionsBox.innerHTML = '';
                            });
                            suggestionsBox.appendChild(div);
                        });
                    }
                }

                document.addEventListener('click', function (event) {
                    if (suggestionsBox && !suggestionsBox.contains(event.target) && event.target !== input) {
                        suggestionsBox.innerHTML = '';
                    }
                });
            }

            setupAutocomplete('start-player', 'start-player-suggestions');
            setupAutocomplete('end-player', 'end-player-suggestions');

            const toggleDarkModeBtn = document.getElementById('toggle-dark-mode');
            if (toggleDarkModeBtn) {
                const isDarkMode = localStorage.getItem('darkMode') === 'true';
                if (isDarkMode) {
                    document.body.classList.add('dark-mode');
                }

                toggleDarkModeBtn.addEventListener('click', function () {
                    document.body.classList.toggle('dark-mode');
                    localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
                });
            }
        });
    </script>
</body>
</html>
